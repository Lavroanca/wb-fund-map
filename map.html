<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Зоны WB и лоты Фонда имущества</title>
  <style>
    html, body, #map {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
    }
  </style>
  <!-- Yandex Maps JS API. При необходимости подставь свой apikey=... -->
  <script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU" type="text/javascript"></script>
</head>
<body>
<div id="map"></div>

<script>
  // Пути к данным (относительно map.html)
  const ZONES_URL = 'wb_zones_merged.geojson';      // полигоны зон WB (lon,lat)
  const LOTS_URL  = 'lots.geojson';                 // точки лотов фонда (Point, lon/lat)

  ymaps.ready(init);

  function swapLonLatInPolygonCoords(coords) {
    // coords: [ [ [lon,lat], ... ], ... ]
    return coords.map(ring => ring.map(([lon, lat]) => [lat, lon]));
  }

  function swapLonLatInMultiPolygonCoords(coords) {
    // coords: [ [ [ [lon,lat], ... ], ... ], ... ]
    return coords.map(poly => poly.map(ring => ring.map(([lon, lat]) => [lat, lon])));
  }

  function init() {
    // Центрируемся примерно на Санкт-Петербурге
    const map = new ymaps.Map('map', {
      center: [59.93, 30.30],
      zoom: 11,
      controls: ['zoomControl', 'searchControl', 'typeSelector', 'fullscreenControl']
    });

    // Слой полигонов зон WB
    fetch(ZONES_URL)
      .then(r => r.json())
      .then(data => {
        if (!data.features) return;
        const zoneObjects = [];

        data.features.forEach(f => {
          if (!f.geometry) return;
          const type = f.geometry.type;
          const coords = f.geometry.coordinates;
          const props = f.properties || {};

          let ymCoords;
          if (type === 'Polygon') {
            ymCoords = swapLonLatInPolygonCoords(coords);
          } else if (type === 'MultiPolygon') {
            ymCoords = swapLonLatInMultiPolygonCoords(coords);
          } else {
            return;
          }

          const polygon = new ymaps.Polygon(ymCoords, {
            hintContent: 'Зона WB',
            balloonContent: '<pre style="max-width: 300px; white-space: pre-wrap;">' +
              JSON.stringify(props, null, 2) + '</pre>'
          }, {
            fillColor: 'rgba(255,0,255,0.15)',
            strokeColor: '#FF00FF',
            strokeWidth: 1
          });

          zoneObjects.push(polygon);
        });

        const zoneCollection = new ymaps.GeoObjectCollection();
        zoneObjects.forEach(z => zoneCollection.add(z));
        map.geoObjects.add(zoneCollection);
      })
      .catch(err => console.error('Zones load error', err));

    // Слой точек лотов фонда имущества
    fetch(LOTS_URL)
      .then(r => r.json())
      .then(data => {
        if (!data.features) return;
        const lotsCollection = new ymaps.GeoObjectCollection();

        data.features.forEach(f => {
          if (!f.geometry || f.geometry.type !== 'Point') return;
          const coords = f.geometry.coordinates; // [lon, lat]
          const props = f.properties || {};

          const title = props.address || props.code || 'Лот';
          const inside = props.inside_wb === true || props.inside_wb === 'true';

          // Yandex ожидает [lat, lon]
          const placemark = new ymaps.Placemark([coords[1], coords[0]], {
            hintContent: title,
            balloonContent: '<pre style="max-width: 300px; white-space: pre-wrap;">' +
              JSON.stringify(props, null, 2) + '</pre>'
          }, {
            preset: inside ? 'islands#redIcon' : 'islands#blueIcon'
          });

          lotsCollection.add(placemark);
        });

        map.geoObjects.add(lotsCollection);
      })
      .catch(err => console.error('Lots load error', err));
  }
</script>
</body>
</html>
