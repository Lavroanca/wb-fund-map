<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Зоны WB + лоты Фонда имущества + Яндекс Маркет (MapLibre)</title>
  <style>
    html, body, #map {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
    }
  </style>
  <link href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css" rel="stylesheet" />
  <script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>
  <!-- Turf.js для точного point-in-polygon по реальным зонам WB -->
  <script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>
</head>
<body>
<div id="map"></div>
<script>
  const WB_STYLE_URL = 'https://wb-maps.wb.ru/api/tiles/style/lightberry-ru.json?key=a6BaPcWAU7k4TRMD6pXz';
  const LOTS_URL = 'lots.geojson'; // наши лоты фонда

  // будущие полигоны Яндекс.Маркета (GeoJSON, генерируется отдельным конвертером vmap3 -> GeoJSON)
  const YM_ZONES_URL = 'ym_zones.geojson';

  // локальный прокси для Яндекс.Маркета (слушает на 8001 порту)
  const YM_PROXY_BASE = 'http://72.56.106.171:8001/ym_recommended_buildings';

  const map = new maplibregl.Map({
    container: 'map',
    style: WB_STYLE_URL,
    center: [30.30, 59.93], // lon, lat (СПб)
    zoom: 11
  });

  map.addControl(new maplibregl.NavigationControl(), 'top-left');

  // -----------------------------
  // ЛОТЫ ФОНДА + попадание в зоны WB
  // -----------------------------

  async function loadLotsAndComputeInsideWB() {
    const resp = await fetch(LOTS_URL);
    const lotsData = await resp.json();

    map.addSource('fund-lots', {
      type: 'geojson',
      data: lotsData
    });

    map.addLayer({
      id: 'fund-lots-layer',
      type: 'circle',
      source: 'fund-lots',
      paint: {
        'circle-radius': 5,
        'circle-color': [
          'case',
          ['==', ['get', 'inside_wb'], true], '#FFD700',   // жёлтый, если в зоне WB
          ['==', ['get', 'inside_wb'], 'true'], '#FFD700',
          '#0066ff'                                        // синий по умолчанию
        ],
        'circle-stroke-color': '#ffffff',
        'circle-stroke-width': 1
      }
    });

    map.once('idle', () => {
      try {
        const zoneFeatures = map.querySourceFeatures('wb-priority-zones', {
          sourceLayer: 'data.priority_zone_united'
        });

        const zones = zoneFeatures.map(f => ({
          type: 'Feature',
          geometry: f.geometry,
          properties: {}
        }));

        console.log('WB zones features for PIP:', zones.length);

        let insideCount = 0;
        lotsData.features.forEach(feat => {
          if (!feat.geometry || feat.geometry.type !== 'Point') return;
          let inside = false;
          for (let i = 0; i < zones.length; i++) {
            if (turf.booleanPointInPolygon(feat, zones[i])) {
              inside = true;
              break;
            }
          }
          feat.properties = feat.properties || {};
          feat.properties.inside_wb = inside;
          if (inside) insideCount++;
        });

        console.log('Lots total:', lotsData.features.length, 'inside WB (client PIP):', insideCount);

        map.getSource('fund-lots').setData(lotsData);
      } catch (e) {
        console.error('Error computing inside_wb:', e);
      }
    });
  }

  // -----------------------------
  // ЯНДЕКС МАРКЕТ: точки LIGHTNING (до 400k) через локальный прокси
  // -----------------------------

  async function fetchYandexLightning() {
    const bounds = map.getBounds();
    const minLat = bounds.getSouth();
    const maxLat = bounds.getNorth();
    const minLon = bounds.getWest();
    const maxLon = bounds.getEast();
    const zoom = Math.round(map.getZoom());

    const url = new URL(YM_PROXY_BASE);
    url.searchParams.set('zoom', String(zoom));
    url.searchParams.set('minLat', String(minLat));
    url.searchParams.set('maxLat', String(maxLat));
    url.searchParams.set('minLon', String(minLon));
    url.searchParams.set('maxLon', String(maxLon));

    console.log('YM proxy fetch:', url.toString());
    const resp = await fetch(url.toString());
    if (!resp.ok) {
      console.error('YM proxy error:', resp.status, await resp.text());
      return { type: 'FeatureCollection', features: [] };
    }
    const data = await resp.json();

    // data: [{id, lat, lon, type}] — берём только LIGHTNING
    const features = (data || [])
      .filter(item => item && item.type === 'LIGHTNING')
      .map(item => ({
        type: 'Feature',
        geometry: {
          type: 'Point',
          coordinates: [item.lon, item.lat],
        },
        properties: {
          id: item.id,
          type: item.type,
        },
      }));

    console.log('YM LIGHTNING points:', features.length);

    return {
      type: 'FeatureCollection',
      features,
    };
  }

  async function initYandexLightningLayer() {
    map.addSource('ym-lightning', {
      type: 'geojson',
      data: { type: 'FeatureCollection', features: [] },
    });

    map.addLayer({
      id: 'ym-lightning-layer',
      type: 'circle',
      source: 'ym-lightning',
      paint: {
        'circle-radius': 6,
        'circle-color': 'rgba(255, 215, 0, 0.7)',        // мягкий золотой
        'circle-stroke-color': 'rgba(0, 0, 0, 0.3)',
        'circle-stroke-width': 1,
      }
    });

    try {
      const fc = await fetchYandexLightning();
      map.getSource('ym-lightning').setData(fc);
    } catch (e) {
      console.error('YM init error:', e);
    }

    map.on('moveend', async () => {
      try {
        const fc = await fetchYandexLightning();
        map.getSource('ym-lightning').setData(fc);
      } catch (e) {
        console.error('YM moveend error:', e);
      }
    });
  }

  map.on('load', () => {
    // 1) Источник с полигонами зон WB напрямую из их тайлов
    map.addSource('wb-priority-zones', {
      type: 'vector',
      tiles: [
        'https://map.wb.ru/tiles/data.priority_zone_united/{z}/{x}/{y}.pbf'
      ],
      minzoom: 5,
      maxzoom: 16
    });

    map.addLayer({
      id: 'wb-priority-zones-fill',
      type: 'fill',
      source: 'wb-priority-zones',
      'source-layer': 'data.priority_zone_united',
      paint: {
        'fill-color': 'rgba(255, 0, 255, 0.18)',
        'fill-outline-color': 'rgba(170, 0, 170, 0.9)'
      }
    });

    map.addLayer({
      id: 'wb-priority-zones-outline',
      type: 'line',
      source: 'wb-priority-zones',
      'source-layer': 'data.priority_zone_united',
      paint: {
        'line-color': 'rgba(170, 0, 170, 0.9)',
        'line-width': 1
      }
    });

    // 2) Полигоны Яндекс.Маркета (конвертированный GeoJSON, если доступен)
    // Формат YM_ZONES_URL: FeatureCollection с Polygon/MultiPolygon,
    // совместимый с turf.booleanPointInPolygon.
    map.addSource('ym-zones', {
      type: 'geojson',
      data: YM_ZONES_URL
    });

    map.addLayer({
      id: 'ym-zones-fill',
      type: 'fill',
      source: 'ym-zones',
      paint: {
        'fill-color': 'rgba(0, 200, 0, 0.18)',
        'fill-outline-color': 'rgba(0, 120, 0, 0.9)'
      }
    });

    map.addLayer({
      id: 'ym-zones-outline',
      type: 'line',
      source: 'ym-zones',
      paint: {
        'line-color': 'rgba(0, 120, 0, 0.9)',
        'line-width': 1
      }
    });

    loadLotsAndComputeInsideWB().catch(err => console.error('Lots init error', err));
    initYandexLightningLayer().catch(err => console.error('YM layer error', err));

    map.on('click', 'fund-lots-layer', (e) => {
      const feature = e.features && e.features[0];
      if (!feature) return;
      const props = feature.properties || {};
      const id = props.id;
      if (!id) return;
      const url = 'https://xn--80adfeoyeh6akig5e.xn--p1ai/realty/spaces/' + id;
      window.open(url, '_blank');
    });

    map.on('mouseenter', 'fund-lots-layer', () => {
      map.getCanvas().style.cursor = 'pointer';
    });
    map.on('mouseleave', 'fund-lots-layer', () => {
      map.getCanvas().style.cursor = '';
    });
  });
</script>
</body>
</html>
