<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Зоны WB + лоты Фонда имущества (MapLibre)</title>
  <style>
    html, body, #map {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
    }
  </style>
  <link href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css" rel="stylesheet" />
  <script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>
</head>
<body>
<div id="map"></div>
<script>
  const WB_STYLE_URL = 'https://wb-maps.wb.ru/api/tiles/style/lightberry-ru.json?key=a6BaPcWAU7k4TRMD6pXz';
  const LOTS_URL = 'lots.geojson'; // наш GeoJSON с лотами

  const map = new maplibregl.Map({
    container: 'map',
    style: WB_STYLE_URL,
    center: [30.30, 59.93], // lon, lat (СПб)
    zoom: 11
  });

  map.addControl(new maplibregl.NavigationControl(), 'top-left');

  map.on('load', () => {
    // 1) Источник с лотами фонда
    map.addSource('fund-lots', {
      type: 'geojson',
      data: LOTS_URL
    });

    map.addLayer({
      id: 'fund-lots-layer',
      type: 'circle',
      source: 'fund-lots',
      paint: {
        'circle-radius': 5,
        'circle-color': [
          'case',
          ['==', ['get', 'inside_wb'], true], '#ff0000',
          ['==', ['get', 'inside_wb'], 'true'], '#ff0000',
          '#0066ff'
        ],
        'circle-stroke-color': '#ffffff',
        'circle-stroke-width': 1
      }
    });

    // 2) Источник с полигонами зон WB напрямую из их тайлов
    map.addSource('wb-priority-zones', {
      type: 'vector',
      tiles: [
        'https://map.wb.ru/tiles/data.priority_zone_united/{z}/{x}/{y}.pbf'
      ],
      minzoom: 5,
      maxzoom: 16
    });

    // 3) Слой полигонов зон WB
    map.addLayer({
      id: 'wb-priority-zones-fill',
      type: 'fill',
      source: 'wb-priority-zones',
      'source-layer': 'data.priority_zone_united',
      paint: {
        'fill-color': 'rgba(255, 0, 255, 0.18)',
        'fill-outline-color': 'rgba(170, 0, 170, 0.9)'
      }
    });

    // 4) Контур зон, чтобы лучше читались
    map.addLayer({
      id: 'wb-priority-zones-outline',
      type: 'line',
      source: 'wb-priority-zones',
      'source-layer': 'data.priority_zone_united',
      paint: {
        'line-color': 'rgba(170, 0, 170, 0.9)',
        'line-width': 1
      }
    });

    // popup по клику на лот
    const popup = new maplibregl.Popup({ closeButton: true, closeOnClick: true });

    map.on('click', 'fund-lots-layer', (e) => {
      const feature = e.features && e.features[0];
      if (!feature) return;
      const coords = feature.geometry.coordinates.slice();
      const props = feature.properties || {};

      popup
        .setLngLat(coords)
        .setHTML('<pre style="max-width: 320px; white-space: pre-wrap;">' +
                 JSON.stringify(props, null, 2) + '</pre>')
        .addTo(map);
    });

    map.on('mouseenter', 'fund-lots-layer', () => {
      map.getCanvas().style.cursor = 'pointer';
    });
    map.on('mouseleave', 'fund-lots-layer', () => {
      map.getCanvas().style.cursor = '';
    });
  });
</script>
</body>
</html>
